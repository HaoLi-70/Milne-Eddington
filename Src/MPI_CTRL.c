
#include "MPI_CTRL.h"

/*--------------------------------------------------------------------------------*/

    /*######################################################################
     
      revision log:
        
        27 Apr. 2024
            --- Initial commit (Hao Li)
     
     ######################################################################*/

/*--------------------------------------------------------------------------------*/

int Mrank;
int Mnprocs;

extern int cpu_check(int *cpu_busy, int ncpu){

/*--------------------------------------------------------------------------------*/

    /*######################################################################
      Purpose:
        return the id of a free cpu if there is.
      Record of revisions:
        25 Apr. 2024 (Hao Li)
      Input parameters:
        cpu_busy, an array with the cpu status.
        ncpu, the length of the array.
      Return:
        .
    ######################################################################*/

/*--------------------------------------------------------------------------------*/
    
    // true = 1, flase = 0;
    int icpu;

    for(icpu=1;icpu<ncpu;icpu++){
      if(!cpu_busy[icpu]) return icpu;
    }

    return 0;

}

/*--------------------------------------------------------------------------------*/

extern void CONTROL(void){

/*--------------------------------------------------------------------------------*/

    /*######################################################################
      Purpose:
        controls if any CPU has crashed and stops if needed..
      Record of revisions:
        25 Apr. 2024 (Hao Li)
      Input parameters:
        .
      Return:
        .
    ######################################################################*/

/*--------------------------------------------------------------------------------*/
    
    MPI_Barrier(MPI_COMM_WORLD);
    
    int a1=0, a2=0;
    
    MPI_Allreduce(&a1, &a2, 1, MPI_INT, MPI_LOR, MPI_COMM_WORLD);
    
    if (!a2) return;
    
    MPI_Finalize();
    
    return;
}

/*--------------------------------------------------------------------------------*/

extern void ABORTED(void){

/*--------------------------------------------------------------------------------*/

    /*######################################################################
      Purpose:
        terminate the job.
      Record of revisions:
        25 Apr. 2024 (Hao Li)
      Input parameters:
        .
      Return:
        .
    ######################################################################*/

/*--------------------------------------------------------------------------------*/
  
  MPI_Finalize();

  exit(0);

}

/*--------------------------------------------------------------------------------*/

